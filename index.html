<!DOCTYPE html>
<meta charset="utf-8">



<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://underscorejs.org/underscore.js"></script>
<script type="text/javascript" src="germany.js"></script>
<script src="http://fgnass.github.io/spin.js/spin.min.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
<link rel="stylesheet" href="style.css" />
<link href='https://fonts.googleapis.com/css?family=Exo+2|Open+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="font-awesome-4.5.0/css/font-awesome.min.css">


<title>
Smart City Lighting Demo
</title>	

<body>


	<div class='header'> 
				<div class='head-line'>  SMART CITY LIGHTING </div>
				<div class= 'last-updated'> </div>
				<div class='image-container'> <img alt="Reply Logo" src="replyLogo.png" height="65" width="65"></div>
	</div>


	<a class='go-back-button fa fa-angle-double-up fa-3x'> </a>

	<div class='info-column'>
		<p class='info-column-header'> </p>
		<p class="info-column-street"> <p>
		<p class="info-column-count-overall"> <p>

		<div id='lampwrapper'>
			<div class='lamp greenLamp'> </div>  <span class='green-info' style ='position: absolute; left: 20%; top: 20px'> Green </span> 
			<div class='lamp redLamp'> </div>    <span class='red-info' style ='position: absolute; left: 20%; top: 55px;' > Red  </span>
		</div>

		<div class='light-details'>
			<div class='light-details-header'></div>
			<div class='light-details-id'></div>
			<div class='light-details-daylight'></div>
			<div class='light-details-state'></div>
		</div>

		<div class='report-button'> Report Light </div>
		<div class='report-message'> Light was reported!</div>


	</div>


  <div id='toolTip'>
		<p class="tool-tip-header"></p> </br>  
		<p class="tool-tip-line"> <p>
		<p class="tool-tip-street"> <p>
  </div>


  <div id='map'></div>

<script>

	var
		GLOBAL_COORDINATES = [51.1, 10],
		GLOBAL_ZOOM = 6,
		CITY_COORDINATES = [51.22, 6.78],
		CITY_ZOOM = 14,
		CITY_SIZE = 10000,
		STREET_ZOOM = 18,
		cityStyle = {
			'color': '#00b04e',
			'fillColor': '#00b04e',
			'fillOpacity': 0.8
		},
		styleGermanyLayer = {
			weight: 2,
			opacity: 0.7,
			color: '#00b04e',
			fillOpacity: 0,
			fillColor: '#00b04e',
			pointerEvents: 'none'
		},
		streetStyle = {
			'color': "#ff7800", 
			'weight': 1
		},
		infoBerlin = {
			'city':'Berlin',
			'lights':8200,
			'on': 8183,
			'off': 17,
			'type': 'city'
		},
		infoMunich = {
			'city':'Munich',
			'lights':4200,
			'on': 4056,
			'off': 144,
			'type': 'city'
		},
		infoDusseldorf = {
			'city':'Düsseldorf',
			'lights':8,
			'on': 8,
			'off': 9,
			'type': 'city'
		},
		infoBenrather = {
			'city':'Benrather Straße',
			'lights':8,
			'on': 8,
			'off': 4,
			'type': 'street'
		},
		benratherRectangle = [[51.2248, 6.77104], [51.22159, 6.78017]],
		lightsBenrather = [
			[51.223175, 6.77436],
			[51.223175, 6.77473],
			[51.223175, 6.77504],
			[51.223175, 6.77539],
			[51.223025, 6.77436],
			[51.223025, 6.77473],
			[51.223025, 6.77504],
			[51.223025, 6.77539],
		],
		germanyLayer,
		map,
		berlin,
		munich,
		dusseldorf,
		benrather,
		renderedLayers = [],
		currentLayer,
		currentlySelectedLayer,
		reportClickEventBound = false,
		countRed = 0,
		countGreen = 0,
		overAllcount = 0,
		ws,
		lampData,
		spinnerOptions = {
				'color': '#00b04e',
				'width': 2
			},
		spinner = new Spinner(spinnerOptions),
		target = $('#map');
		


	var computeCentroid = function(e) {

		var 
			lat = 0,
			lng = 0;

		e.target._latlngs.forEach(function(obj) {
			lat += obj.lat;
			lng += obj.lng;
		});

		lat *= 0.25;
		lng *= 0.25;

		return [lat,lng];

	};


	var removeZoomControl = function() {
		$('.leaflet-control-container').remove()
	};


	var moveToolTip = function(e, reset) {

		var 
			e = e['originalEvent'],
			elem = document.getElementById("toolTip").style,
			left = e.clientX+'px',
			top = (e.clientY+40)+'px';

		if (reset === true) {
			left = 0;
			top = 0;
		}

		elem.left = left;
		elem.top = top;
	};


	var setTimeLastVisited = function() {

		var 
			d = new Date(),
			minutes = d.getMinutes(),
			hours = d.getHours();

		if (minutes < 10) {
			minutes = '0' + minutes;
		}
		if (hours < 10) {
			hours = '0' + hours;
		}
		$('.last-updated').html('Last Update: ' + hours +':'+ minutes)
	};


	var bindMouseEvents = function(obj) {
		obj.on('mouseover', onMouseOver);
		obj.on('mousemove', onMouseMove);
		obj.on('mouseout', onMouseOut);

		if (obj.info.city === 'Düsseldorf') {
			obj.on('click', renderCityView)
		}

		else if (obj.info.type === 'street') {
			obj.on('click', renderStreetView)
		}

		else if (obj.info.type === 'light') {
			obj.on('click', showLightDetails)
		}

	};


	var onMouseOver = function(e) {

		var	
			info = e.target.info,
			toolTip = $('#toolTip'), 
			header = $('.tool-tip-header'),
			line = $('.tool-tip-line'),
			type = info.type,
			toolTipMessage = (type === 'light') ? info.day + ' - Status: '  + info.state :  'Active Lights: ' + info.on;

		toolTip.fadeIn(100)
		moveToolTip(e)
		header.html(info.city)


		line.html(toolTipMessage)	
	};


	var onMouseMove = function(e) {
		moveToolTip(e);
	};


	var onMouseOut = function(e) {
		var toolTip = $('#toolTip') 
		toolTip.css({'display':'none'});
		moveToolTip(e, true);
	};


	var showLightDetails = function(e) {

		var 
			header = $('.light-details-header'),
			id = $('.light-details-id'),
			day = $('.light-details-daylight'),
			state = $('.light-details-state'),
			info = e.target.info;

			unSelectLight();
			currentlySelectedLayer = e.target;
			e.target.setStyle({'fillColor':'white'})
			header.html('Light Details')
			id.html('Selected light ID: ' + info.city);
			day.html('Current environment: ' + info.day);
			state.html('State of the light: ' +info.state);
			$('.report-mask').css({'display':'none'})
	};



	var createVectorLayers = function() {
		createCountryLayer();
		createCityLayers();
		createStreetLayers();
	};


	var createCountryLayer = function() {
		germanyLayer = L.geoJson(germanyShape, {style: styleGermanyLayer });
	};


	var createCityLayers = function() {
		berlin = L.circle([52.529, 13.403], CITY_SIZE, cityStyle);
		munich = L.circle([48.12, 11.6], CITY_SIZE, cityStyle);
		dusseldorf = L.circle(CITY_COORDINATES, CITY_SIZE, cityStyle);

		berlin.info = infoBerlin;
		bindMouseEvents(berlin);

		munich.info = infoMunich;
		bindMouseEvents(munich);

		dusseldorf.info = infoDusseldorf;		
		bindMouseEvents(dusseldorf)
	};


	var createStreetLayers =function() {
		benrather = L.rectangle(benratherRectangle, streetStyle);
		benrather.info = infoBenrather;
		bindMouseEvents(benrather);
	};


	var clearView = function() {
		hideGoBackButton();
		hideInfoColumn();
		emptyInfoColumn();
		resetLightCount();
		hideToolTip();
		unsetZoomConstraint();
		renderedLayers.forEach(function(layer) {
			map.removeLayer(layer)
		})
	};


	var resetLightCount = function() {
		countRed = 0;
		countGreen = 0;
		overAllcount = 0;
	};


	var emptyInfoColumn = function() {

		var
			infoColumn = $('.info-column'),  
			header = $('.info-column-header'),
			street = $('.info-column-street'),
			count = $('.info-column-count-overall'),
			lampWrapper = $('#lampwrapper'),
			lightDetails = $('.light-details'),
			reportButton = $('.report-button');

		header.html('');
		street.html('');
		count.html('');
		lampWrapper.css({'display':'none'});
		lightDetails.css({'display':'none'});
		reportButton.css({'display':'none'});
		emptyLightDetails();
	};


	var emptyLightDetails = function() {

		var lightDetails = $('.light-details');
		lightDetails.children().each(
			function(i,children) { 
				$(children).html('')
			})
	}; 


	var unsetZoomConstraint = function() {
		map.options.maxZoom = 20;		
		map.options.minZoom = 1;	
	};


	var setZoomConstraint = function(zoom) {
		map.options.maxZoom = zoom;		
		map.options.minZoom = zoom;	
	};


	var hideToolTip = function() {
		var toolTip = $('#toolTip');
		toolTip.fadeOut(0);
		toolTip.css({'display':'none'});
	};


	var hideInfoColumn = function() {
		if (currentLayer === 'world') {
			var infoColumn = $('.info-column')
			infoColumn.fadeOut(200)
			infoColumn.css({'display':'none'})
		}	
	};


	var hideGoBackButton = function() {
		if (currentLayer === 'world' || currentLayer === undefined) {
			$('.go-back-button').css({'display':'none'})
		}
	};

	var bindClickEvents = function() {
		bindBackButton()
		map.on('click', onMapClick);
		$('.report-button').on('click', function() {
			if (currentlySelectedLayer !== undefined) {
				$('.report-message').fadeIn(0)
				$('.report-message').fadeOut(3500)
				reportClickEventBound = true;
			}
		});
	}


	var bindBackButton = function() {
		$('.go-back-button').on('click', goLayerUp);
	};


	var goLayerUp = function() {

		if (currentLayer === 'city') {
			renderWorldView();
		} else if(currentLayer === 'street') {
			renderCityView();
		} 
	};


	var enableControls = function() {
		if (currentLayer === 'city' || currentLayer === 'street') {
			$('.info-column').fadeIn(0)
			$('.go-back-button').css({'display':'inline'})
		}
	};



	var init = function() {

		ws = new WebSocket("ws://nodered.reply-live.de/ws/test");
		map = L.map('map');
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
		id: 'tburri.paf6hb5o',
		accessToken: 'pk.eyJ1IjoidGJ1cnJpIiwiYSI6ImNpbGNranp4ZzAwNzZ3OW0yenpiZmEwY2IifQ.Aoisnn9fFWFxmoFwXbEtCg'
		}).addTo(map);		
		setTimeLastVisited();
		removeZoomControl();
		createVectorLayers()
		bindClickEvents();
		//renderWorldView();
		bindWebSocketEvents();	
	};

	var bindWebSocketEvents = function() {

		ws.onopen = function() {
			console.log('Socket was opened!');
			ws.send('getall')
		}

		ws.onmessage = function(evt) {

			if (lampData === undefined) {
				hideGoBackButton();
				lampData = JSON.parse(evt.data);
				console.log(lampData);
				spinner.stop();
				renderWorldView();
			} else {
				console.log('Light data was updated!')
				lampData = JSON.parse(evt.data);
				if (currentLayer === 'street') {
					clearView();
					enableControls();
					lightsBenrather.forEach(addLightToLayer)
					populateInfoColumn('Benrather');
					console.log('Streetview was updated!')
				}
			}
		}
	}




	var renderWorldView = function() {

		currentLayer = 'world';
		clearView();

		map.setView(GLOBAL_COORDINATES, GLOBAL_ZOOM);
		setZoomConstraint(GLOBAL_ZOOM);

		berlin.addTo(map);
		munich.addTo(map);
		dusseldorf.addTo(map);
		germanyLayer.addTo(map);

		renderedLayers.push(berlin, munich, dusseldorf, germanyLayer);
	};


	var renderCityView = function() {

		currentLayer = 'city';
		clearView();
		enableControls();

		map.setView(CITY_COORDINATES, CITY_ZOOM);
		setZoomConstraint(CITY_ZOOM);
		
		benrather.addTo(map);
		renderedLayers.push(benrather);
		populateInfoColumn();
	};


	var addLightToLayer = function(coordinates, i) {

		var 
			ranNum = Math.random(),
			color = lampData[i]['envior_status'] !== lampData[i]['lamp_status'] ? '#00b04e' : 'red',
			light = L.circle(coordinates, 2, {
				color: color,
				fillColor: color,
				fillOpacity: 0.8
			}).addTo(map);


		light.info = {
			'city': lampData[i]['gateway_id'].substring(0,6) + lampData[i]['lamp_id'] , 
			'day': lampData[i]['envior_status'] === '1' ? 'Daylight':'No Daylight',
			'state': lampData[i]['lamp_status'] === '1' ? 'ON' : 'OFF',
			'type': 'light',
			'color': color
		}


		lampData[i]['envior_status'] === lampData[i]['lamp_status'] ? countGreen++ : countRed++;
		overAllcount++;
		bindMouseEvents(light);
		renderedLayers.push(light);
	};


	var populateInfoColumn = function(streetName) {
		var	
			header = $('.info-column-header'),
			streetLabel = $('.info-column-street'),
			reportButton = $('.report-button');

		if (currentLayer === 'city') {
			header.html('Düsseldorf');
		} else if (currentLayer === 'street') {
			header.html('Düsseldorf');
			streetLabel.html(streetName);
			$('.info-column-count-overall').html('Number of Lights: ' + overAllcount);
			$('#lampwrapper').fadeIn(100);
			$('.light-details').fadeIn(100);
			$('.green-info').html('Functional Lights ' + countGreen);
			$('.red-info').html('Disfunctional Lights: ' + countRed);
			reportButton.fadeIn(100);
		}
	};


	var renderStreetView = function(e) {

		var 
			centroid = computeCentroid(e), 
			streetName = e.target.info.city,
			lights;

			if (streetName === 'Benrather Straße') {
				lights = lightsBenrather;
			}	

		currentLayer = 'street';
		clearView();
		enableControls();

		map.setView(centroid, STREET_ZOOM);
		setZoomConstraint(STREET_ZOOM);
		lights.forEach(addLightToLayer)
		populateInfoColumn(streetName);
	};


	var unSelectLight = function() {
		if (currentlySelectedLayer !== undefined) {
			emptyLightDetails();
			currentlySelectedLayer.setStyle({'fillColor':currentlySelectedLayer.info.color})
			currentlySelectedLayer = undefined;
		}
	}


	var onMapClick = function() {
		unSelectLight();
	};

	
	spinner.spin();
	target.append(spinner.el);
	init();


	/*
	var popup = L.popup();
	function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent("You clicked the map at " + e.latlng.toString())
			.openOn(map);
	} */




</script>


</body>

</html>


