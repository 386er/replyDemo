<!DOCTYPE html>
<meta charset="utf-8">



<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://underscorejs.org/underscore.js"></script>
<script type="text/javascript" src="germany.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
<link rel="stylesheet" href="style.css" />
<link href='https://fonts.googleapis.com/css?family=Exo+2|Open+Sans' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="font-awesome-4.5.0/css/font-awesome.min.css">


<title>
Smart City Lighting Demo
</title>	

<body>


	<div class='header'> 

				<div class='head-line'>  SMART CITY LIGHTING </div>
				<div class= 'last-updated'> </div>
				<div class='image-container'> <img alt="Reply Logo" src="replyLogo.png" height="65" width="65"></div>

	</div>


	<a class='go-back-button fa fa-caret-square-o-up fa-4x'> </a>




	<div class='info-column'>
		<p class='info-column-header'> </p>
		<p class="info-column-street"> <p>
		<p class="info-column-count-overall"> <p>
		<div id='lampwrapper'>
			<div class='greenLamp'> </div>  <span class='green-info' style ='position: absolute; left: 25%; top: 10px'> Green </span> 
			<div class='redLamp'> </div>    <span class= 'red-info' style ='position: absolute; left: 25%; top: 45px;' > Red   </span>
		</div>
	</div>


  <div id='toolTip'>
		<p class="tool-tip-header"></p> </br>  
		<p class="tool-tip-line"> <p>
		<p class="tool-tip-street"> <p>
  </div>


  <div id='map'></div>

<script>

	var
		GLOBAL_COORDINATES = [51.1, 10],
		GLOBAL_ZOOM = 6,
		CITY_ZOOM = 14,
		CITY_SIZE = 10000,
		STREET_ZOOM = 18,
		cityStyle = {
			'color': '#00b04e',
			'fillColor': '#00b04e',
			'fillOpacity': 0.8
		},
		streetStyle = {
			'color': "#ff7800", 
			'weight': 1
		},
		infoBerlin = {
			'city':'Berlin',
			'lights':8200,
			'on': 8183,
			'off': 17
		},
		infoMunich = {
			'city':'Munich',
			'lights':4200,
			'on': 4056,
			'off': 144
		},
		infoDusseldorf = {
			'city':'Düsseldorf',
			'lights':3120,
			'on': 3111,
			'off': 9
		},
		infoBenrather = {
			'city':'Benrather Straße',
			'lights':12,
			'on': 12,
			'off': 4
		},
		infoHerzog = {
			'city':'Herzogstraße',
			'lights':12,
			'on': 12,
			'off': 4
		},
		benratherRectangle = [[51.2248, 6.77104], [51.22159, 6.78017]],
		herzogRectangle = [[51.21736, 6.77687], [51.21396, 6.78612]],
		germanyLayer,
		map,
		berlin,
		munich,
		dusseldorf,
		herzog,
		benrather,
		currentLayers = [];

	var computeCentroid = function(e) {

		var 
			lat = 0,
			lng = 0;

		e.target._latlngs.forEach(function(obj) {
			lat += obj.lat;
			lng += obj.lng;
		});

		lat *= 0.25;
		lng *= 0.25;

		return [lat,lng];

	};


	var removeZoomControl = function() {
		$('.leaflet-control-container').remove()
	};



	var moveToolTip = function(e, reset) {

		var 
			e = e['originalEvent'],
			elem = document.getElementById("toolTip").style,
			left = e.clientX+'px',
			top = (e.clientY+40)+'px';

		if (reset === true) {
			left = 0;
			top = 0;
		}

		elem.left = left;
		elem.top = top;
	};


	var setTimeLastVisited = function() {

		var 
			d = new Date(),
			minutes = d.getMinutes(),
			hours = d.getHours();

		if (minutes < 10) {
			minutes = '0' + minutes;
		}
		if (hours < 10) {
			hours = '0' + hours;
		}
		$('.last-updated').html('Last Update: ' + hours +':'+ minutes)
	};


	var bindMouseEvents = function(obj) {
		obj.on('mouseover', onCityOver);
		obj.on('mousemove', onCityMove);
		obj.on('mouseout', onCityOut);
	};


	var onCityOver = function(e) {

		var	
			info = e.target.info,
			toolTip = $('#toolTip'), 
			header = $('.tool-tip-header'),
			line = $('.tool-tip-line');

		toolTip.fadeIn(100)
		moveToolTip(e)
		header.html(info.city)
		line.html('Active Lights: ' + info.on)	
	};

	var onCityMove = function(e) {
		moveToolTip(e);
	};


	var onCityOut = function(e) {
		var toolTip = $('#toolTip') 
		toolTip.css({'display':'none'});
		moveToolTip(e, true);
	};


	var onlightOver = function(e) {
		var info = e.target.info;
		var toolTip = $('#toolTip') 
		var header = $('.tool-tip-header')
		var line = $('.tool-tip-line')
		
		toolTip.fadeIn(100)
		moveToolTip(e);

		header.html(info.id)
		line.html('Daylight  - Light state: ' + info.state)
	};



	var onStreetClick = function (e) {

		var 
			streetLabel = $('.info-column-street'),
			toolTip = $('#toolTip'),
			centroid = computeCentroid(e);

		streetLabel.html(e.target.info.city)
		toolTip.fadeOut(100)

		map.options.maxZoom = STREET_ZOOM;
		map.setView(centroid, STREET_ZOOM)
		map.options.minZoom = STREET_ZOOM;
		map.removeLayer(e.target)
		showBenrather();
	};


	var createCountryLayer = function() {
		germanyLayer = L.geoJson(germanyShape, {style: style });
	};


	var createCityLayers = function() {
		berlin = L.circle([52.529, 13.403], CITY_SIZE, cityStyle);
		munich = L.circle([48.12, 11.6], CITY_SIZE, cityStyle);
		dusseldorf = L.circle([51.22, 6.78], CITY_SIZE, cityStyle);

		berlin.info = infoBerlin;
		bindMouseEvents(berlin);

		munich.info = infoMunich;
		bindMouseEvents(munich);

		bindMouseEvents(dusseldorf)
		dusseldorf.on('click', renderCityView)
		dusseldorf.info = infoDusseldorf;		
	};


	var createStreetLayers = function() {

		benrather = L.rectangle(benratherRectangle, streetStyle);
		benrather.on('click', onStreetClick);
		benrather.info = infoBenrather;
		bindMouseEvents(benrather);

		herzog = L.rectangle(herzogRectangle, streetStyle);
		herzog.on('click', onStreetClick);
		herzog.info = infoHerzog;
		bindMouseEvents(herzog);
	};


	var clearLayers = function() {

		currentLayers.forEach(function(layer) {
			map.removeLayer(layer)
		})
	};


	var unsetZoomConstraint = function() {
		map.options.maxZoom = 20;		
		map.options.minZoom = 1;	
	};

	var setZoomConstraint = function(zoom) {
		map.options.maxZoom = zoom;		
		map.options.minZoom = zoom;	
	};


	var	style = function (feature) {
		return {
			weight: 2,
			opacity: 0.7,
			color: '#00b04e',
			fillOpacity: 0,
			fillColor: '#00b04e',
			pointerEvents: 'none'
		};
	};


	var hideInfoColumn = function() {
		var infoColumn = $('.info-column')
		infoColumn.fadeOut(200)
		infoColumn.css({'display':'none'})
	};

	var bindBackButton = function() {
		$('.go-back-button').on('click', renderWorldView);
	};



	var init = function() {
		map = L.map('map')
		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
		id: 'tburri.paf6hb5o',
		accessToken: 'pk.eyJ1IjoidGJ1cnJpIiwiYSI6ImNpbGNranp4ZzAwNzZ3OW0yenpiZmEwY2IifQ.Aoisnn9fFWFxmoFwXbEtCg'
		}).addTo(map);		
		setTimeLastVisited();
		removeZoomControl();
		createCountryLayer();
		createCityLayers();
		createStreetLayers();
		bindBackButton();
	};



	var renderWorldView = function() {

		hideInfoColumn();
		clearLayers();
		unsetZoomConstraint()

		map.setView(GLOBAL_COORDINATES, GLOBAL_ZOOM);
		setZoomConstraint(GLOBAL_ZOOM);

		berlin.addTo(map);
		munich.addTo(map);
		dusseldorf.addTo(map);
		germanyLayer.addTo(map);

		currentLayers.push(berlin, munich, dusseldorf, germanyLayer);
	};

	var renderCityView = function(e) {

		var 
			location = e.target._latlng,
			toolTip = $('#toolTip'),
			header = $('.info-column-header');

		$('.info-column').fadeIn(200)
		$('.go-back-button').css({'color':'white'})

		clearLayers();
		unsetZoomConstraint();

		map.setView(location, CITY_ZOOM);
		setZoomConstraint(CITY_ZOOM);
		

		benrather.addTo(map);
		herzog.addTo(map);
		toolTip.fadeOut(100)
		header.html(e.target.info.city)
		
	};


	init();
	renderWorldView();






	var showBenrather = function() {


		var coordinates = [
						[51.22322, 6.77551], 
						[51.22340, 6.77551],
						[51.22358, 6.77551],
						[51.22376, 6.77551],
						[51.22394, 6.77551],
						[51.22412, 6.77551],
						[51.22431, 6.77551],
						[51.22315, 6.77436],
						[51.22315, 6.77463],
						[51.22315, 6.77485],
						[51.22315, 6.77505],
						[51.22315, 6.77525],
						];	
						
		lightContainer = []
		countRed = 0;
		countGreen = 0;
		overAllcount = coordinates.length;




		coordinates.forEach( function(coordinate, i) {

			var ranNum = Math.random();

			var color = ranNum > 0.25 ? '#00b04e' : 'red';

			ranNum > 0.25 ? countGreen++ : countRed++;


			var light = L.circle(coordinate, 2, {
				color: color,
				fillColor: color,
				fillOpacity: 0.8
			}).addTo(map)

				light.info = {
					'id': (3224392 + i ), 
					'day': 'Daylight',
					'state': (color === 'red') ? 'ON' : 'OFF'
				}

				light.on('mouseover', onlightOver)
				light.on('mousemove', onCityMove)
				light.on('mouseout',  onCityOut)

			})


		$('.info-column-count-overall').html('Number of Lights: ' + overAllcount);
		$('#lampwrapper').fadeIn(100);
		$('.green-info').html('Functional Lights ' + countGreen)
		$('.red-info').html('Disfunctional Lights: ' + countRed)

	}



	var popup = L.popup();




	function onMapClick(e) {
		popup
			.setLatLng(e.latlng)
			.setContent("You clicked the map at " + e.latlng.toString())
			.openOn(map);
	}


	map.on('click', onMapClick);



</script>


</body>

</html>


