<!DOCTYPE html>
<meta charset="utf-8">



<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://underscorejs.org/underscore.js"></script>
<script type="text/javascript" src="germany.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/>
<link rel="stylesheet" href="style.css" />
<link href='https://fonts.googleapis.com/css?family=Exo+2|Open+Sans' rel='stylesheet' type='text/css'>


<title>
Smart City Lighting Demo
</title>	

<body>


	<div class='header'> 

				<div class='head-line'>  SMART CITY LIGHTING </div>
				<div class= 'last-updated'> </div>
				<div class='image-container'> <img alt="Reply Logo" src="replyLogo.png" height="65" width="65"></div>

	</div>

	<div class='info-column'>
		<p class='info-column-header'> </p>
		<p class="info-column-street"> <p>
		<p class="info-column-count-overall"> <p>
		<div id='lampwrapper'>
			<div class='greenLamp'> </div>  <span class='green-info' style ='position: absolute; left: 25%; top: 10px'> Green </span> 
			<div class='redLamp'> </div>    <span class= 'red-info' style ='position: absolute; left: 25%; top: 45px;' > Red   </span>
		</div>
	</div>


  <div id='toolTip'>
		<p class="tool-tip-header"></p> </br>  
		<p class="tool-tip-line"> <p>
		<p class="tool-tip-street"> <p>
  </div>


  <div id='map'></div>

<script>

	var computeCentroid = function(e) {

		var 
			lat = 0,
			lng = 0;

		e.target._latlngs.forEach(function(obj) {
			lat += obj.lat;
			lng += obj.lng;
		});

		lat *= 0.25;
		lng *= 0.25;

		return [lat,lng];

	};



	var moveToolTip = function(e, reset) {

		var 
			e = e['originalEvent'],
			elem = document.getElementById("toolTip").style,
			left = e.clientX+'px',
			top = (e.clientY+40)+'px';

		if (reset === true) {
			left = 0;
			top = 0;
		}

		elem.left = left;
		elem.top = top;
	};


	var setTime = function() {

		var 
			d = new Date(),
			minutes = d.getMinutes(),
			hours = d.getHours();

		if (minutes < 10) {
			minutes = '0' + minutes;
		}
		if (hours < 10) {
			hours = '0' + hours;
		}
		$('.last-updated').html('Last Update: ' + hours +':'+ minutes)
	};


	setTime();


	var globalCoordinates = [51.1, 10];
	var globalZoom = 6 


	var map = L.map('map').setView(globalCoordinates, globalZoom);

	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
	//L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
    id: 'tburri.paf6hb5o',
    accessToken: 'pk.eyJ1IjoidGJ1cnJpIiwiYSI6ImNpbGNranp4ZzAwNzZ3OW0yenpiZmEwY2IifQ.Aoisnn9fFWFxmoFwXbEtCg'
	}).addTo(map);
	$('.leaflet-control-container').remove()





	var onCityOver = function(e) {
		var info = e.target.info;
		var toolTip = $('#toolTip') 
		var header = $('.tool-tip-header')
		var line = $('.tool-tip-line')
		toolTip.fadeIn(100)
		moveToolTip(e)


		header.html(info.city)
		line.html('Active Lights: ' + info.on)
	};

	var onCityMove = function(e) {
		moveToolTip(e);
	};


	var onCityOut = function(e) {
		var toolTip = $('#toolTip') 
		toolTip.css({'display':'none'});
		moveToolTip(e, true);
	};


	var onlightOver = function(e) {
		var info = e.target.info;
		var toolTip = $('#toolTip') 
		var header = $('.tool-tip-header')
		var line = $('.tool-tip-line')
		
		toolTip.fadeIn(100)
		moveToolTip(e);

		header.html(info.id)
		line.html('Daylight  - Light state: ' + info.state)
	};



	var onCityClick = function(e) {
		var location = e.target._latlng
		var toolTip = $('#toolTip')
		var header = $('.info-column-header')

		map.options.maxZoom = 18;
		map.setView(location, 14)
		map.options.minZoom = 14

		map.removeLayer(e.target)
		toolTip.fadeOut(100)
		header.html(e.target.info.city)

		showDuesseldorf();
	};


	var onStreetClick = function (e) {

		var 
			streetLabel = $('.info-column-street'),
			toolTip = $('#toolTip'),
			centroid = computeCentroid(e);

		streetLabel.html(e.target.info.city)
		toolTip.fadeOut(100)
		map.setView(centroid, 18)
		map.removeLayer(e.target)
		showBenrather();
	};


	var	style = function (feature) {
			return {
				weight: 2,
				opacity: 0.7,
				color: '#00b04e',
				fillOpacity: 0,
				fillColor: 'transparent',
				pointerEvents: 'none'
			};
		}

	var	geojson = L.geoJson(germanyShape, {
			style: style
		}).addTo(map);



	var berlin = L.circle([52.529, 13.403], 10000, {
	    color: '#00b04e',
	    fillColor: '#00b04e',
	    fillOpacity: 0.8
	}).addTo(map);

	berlin.info = {
		'city':'Berlin',
		'lights':8200,
		'on': 8183,
		'off': 17
	}

	berlin.on('mouseover', onCityOver)
	berlin.on('mousemove', onCityMove)
	berlin.on('mouseout', onCityOut)

	var munich = L.circle([48.12, 11.6], 10000, {
	    color: '#00b04e',
	    fillColor: '#00b04e',
	    fillOpacity: 0.8
	}).addTo(map);

	munich.info = {
	'city':'Munich',
	'lights':4200,
	'on': 4056,
	'off': 144
	}

	munich.on('mouseover', onCityOver)
	munich.on('mousemove', onCityMove)
	munich.on('mouseout', onCityOut)

	var dusseldorf = L.circle([51.22, 6.78], 10000, {
	    color: '#00b04e',
	    fillColor: '#00b04e',
	    fillOpacity: 0.8,
	    info: {'peter':'paul'}
	}).addTo(map);

	dusseldorf.on('mouseover', onCityOver)
	dusseldorf.on('mousemove', onCityMove)
	dusseldorf.on('mouseout', onCityOut)
	dusseldorf.on('click', onCityClick)

	dusseldorf.info = {
	'city':'Düsseldorf',
	'lights':3120,
	'on': 3111,
	'off': 9
	}




	var showDuesseldorf = function() {

		$('.info-column').fadeIn(200)


		var detailOne = [[51.2248, 6.77104], [51.22159, 6.78017]];
		var benrather = L.rectangle(detailOne, {color: "#ff7800", weight: 1, }).addTo(map);
		benrather.info = {
		'city':'Benrather Straße',
		'lights':12,
		'on': 12,
		'off': 4
		}

		benrather.on('click', onStreetClick)
		benrather.on('mouseover', onCityOver)
		benrather.on('mousemove', onCityMove)
		benrather.on('mouseout', onCityOut)


		var detailTwo = [[51.21736, 6.77687], [51.21396, 6.78612]];
		var herzog = L.rectangle(detailTwo, {color: "#ff7800", weight: 1, }).addTo(map);
		herzog.info = {
		'city':'Herzogstraße',
		'lights':12,
		'on': 12,
		'off': 4
		}

		herzog.on('click', onStreetClick)
		herzog.on('mouseover', onCityOver)
		herzog.on('mousemove', onCityMove)
		herzog.on('mouseout', onCityOut)



	}

	var showBenrather = function() {


		var coordinates = [
						[51.22322, 6.77551], 
						[51.22340, 6.77551],
						[51.22358, 6.77551],
						[51.22376, 6.77551],
						[51.22394, 6.77551],
						[51.22412, 6.77551],
						[51.22431, 6.77551],
						[51.22315, 6.77436],
						[51.22315, 6.77463],
						[51.22315, 6.77485],
						[51.22315, 6.77505],
						[51.22315, 6.77525],
						];	
						
		lightContainer = []
		countRed = 0;
		countGreen = 0;
		overAllcount = coordinates.length;




		coordinates.forEach( function(coordinate, i) {

			var ranNum = Math.random();

			var color = ranNum > 0.25 ? '#00b04e' : 'red';

			ranNum > 0.25 ? countGreen++ : countRed++;


			var light = L.circle(coordinate, 2, {
			    color: color,
			    fillColor: color,
			    fillOpacity: 0.8
			}).addTo(map)

				light.info = {
					'id': (3224392 + i ), 
					'day': 'Daylight',
					'state': (color === 'red') ? 'ON' : 'OFF'
				}

				light.on('mouseover', onlightOver)
				light.on('mousemove', onCityMove)
				light.on('mouseout',  onCityOut)

			})


		$('.info-column-count-overall').html('Number of Lights: ' + overAllcount);
		$('#lampwrapper').fadeIn(100);
		$('.green-info').html('Functional Lights ' + countGreen)
		$('.red-info').html('Disfunctional Lights: ' + countRed)

	}



	var popup = L.popup();




	function onMapClick(e) {
	    popup
	        .setLatLng(e.latlng)
	        .setContent("You clicked the map at " + e.latlng.toString())
	        .openOn(map);
	}


	map.on('click', onMapClick);



</script>


</body>

</html>